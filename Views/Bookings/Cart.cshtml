@model Tuple<List<EventBooking.Models.Booking>, List<EventBooking.Models.BookingCatering>, List<EventBooking.Models.BookingService>>
@using System.Globalization
@{
    Layout = "_Layout";
}

<div class="container py-5">
    <h2 class="mb-5 text-primary fw-bold">Your Shopping Cart</h2>

    @if (!Model.Item1.Any() && !Model.Item2.Any() && !Model.Item3.Any())
    {
        <div class="alert alert-info shadow-sm rounded p-4 text-center">
            <h5>Your cart is empty</h5>
            <p class="mb-0">Start by booking a venue or adding services to your cart.</p>
            @using (Html.BeginForm("CreateEvent", "Bookings", FormMethod.Get))
            {
                <button type="submit" class="btn btn-outline-primary mt-3">
                    <i class="bi bi-plus-circle"></i> Book a Venue
                </button>
            }
        </div>
    }
    else
    {
        <!-- Event Bookings -->
        @if (Model.Item1.Any())
        {
            <div class="card mb-4 shadow-sm">
                <div class="card-header bg-primary text-white fw-bold">Event Bookings</div>
                <div class="card-body p-0">
                    <div class="table-responsive">
                        <table class="table table-hover align-middle mb-0">
                            <thead class="table-light">
                                <tr>
                                    <th>Venue</th>
                                    <th>Start</th>
                                    <th>End</th>
                                    <th>People</th>
                                    <th>Total</th>
                                    <th class="text-center">Actions</th>
                                </tr>
                            </thead>
                            <tbody>
                                @for (int i = 0; i < Model.Item1.Count; i++)
                                {
                                    var item = Model.Item1[i];
                                    <tr>
                                        <td>@item.Event.Venue</td>
                                        <td>@item.EventStartTime.ToString("g", CultureInfo.CurrentCulture)</td>
                                        <td>@item.EventEndTime.ToString("g", CultureInfo.CurrentCulture)</td>
                                        <td>@item.NumberOfPeople</td>
                                        <td class="fw-bold">@item.TotalAmount.ToString("C", CultureInfo.CurrentCulture)</td>
                                        <td class="text-center">
                                            @using (Html.BeginForm("RemoveEventFromCart", "Bookings", FormMethod.Post, new { @class = "remove-form" }))
                                            {
                                                @Html.AntiForgeryToken()
                                                @Html.Hidden("index", i)
                                                <button type="submit" class="btn btn-sm btn-danger">
                                                    <i class="bi bi-trash"></i>
                                                </button>
                                            }
                                        </td>
                                    </tr>
                                }
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        }

        <!-- Catering -->
        @if (Model.Item2.Any())
        {
            <div class="card mb-4 shadow-sm">
                <div class="card-header bg-success text-white fw-bold">Catering Items</div>
                <div class="card-body p-0">
                    <div class="table-responsive">
                        <table class="table table-hover align-middle mb-0">
                            <thead class="table-light">
                                <tr>
                                    <th>Menu</th>
                                    <th>Quantity</th>
                                    <th>Unit Price</th>
                                    <th>Total</th>
                                    <th class="text-center">Actions</th>
                                </tr>
                            </thead>
                            <tbody>
                                @for (int i = 0; i < Model.Item2.Count; i++)
                                {
                                    var item = Model.Item2[i];
                                    <tr>
                                        <td>@item.CateringMenu.MenuName</td>
                                        <td>
                                            <input type="number" name="quantity" min="1" value="@item.Quantity" class="form-control form-control-sm quantity-input" data-unit="@item.UnitPrice" />
                                        </td>
                                        <td>@item.UnitPrice.ToString("C", CultureInfo.CurrentCulture)</td>
                                        <td class="fw-bold">@item.TotalPrice.ToString("C", CultureInfo.CurrentCulture)</td>
                                        <td class="text-center">
                                            @using (Html.BeginForm("RemoveCateringFromCart", "Bookings", FormMethod.Post, new { @class = "remove-form" }))
                                            {
                                                @Html.AntiForgeryToken()
                                                @Html.Hidden("index", i)
                                                <button type="submit" class="btn btn-sm btn-danger">
                                                    <i class="bi bi-trash"></i>
                                                </button>
                                            }
                                        </td>
                                    </tr>
                                }
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        }
        <!-- Decoration Services -->
        @if (Model.Item3.Any())
        {
            <div class="card mb-4 shadow-sm">
                <div class="card-header bg-warning text-dark fw-bold">Decoration Services</div>
                <div class="card-body p-0">
                    <div class="table-responsive">
                        <table class="table table-hover align-middle mb-0">
                            <thead class="table-light">
                                <tr>
                                    <th>Service</th>
                                    <th>Quantity</th>
                                    <th>Unit Price</th>
                                    <th>Total</th>
                                    <th class="text-center">Actions</th>
                                </tr>
                            </thead>
                            <tbody>
                                @for (int i = 0; i < Model.Item3.Count; i++)
                                {
                                    var item = Model.Item3[i];
                                    <tr>
                                        <td>@item.AdditionalService?.ServiceName</td>
                                        <td>
                                            @(item.AdditionalService?.PriceType == "Fixed"
                                                                            ? "N/A"
                                                                            : Html.Raw($"<input type='number' name='quantity' min='1' value='{item.Quantity}' class='form-control form-control-sm quantity-input' data-unit='{item.UnitPrice.ToString(System.Globalization.CultureInfo.InvariantCulture)}' />"))

                                        </td>
                                        <td>@item.UnitPrice.ToString("C", CultureInfo.CurrentCulture)</td>
                                        <td class="fw-bold">
                                            @(item.AdditionalService?.PriceType == "Fixed"
                                                                            ? item.UnitPrice.ToString("C", CultureInfo.CurrentCulture)
                                                                            : item.TotalPrice.ToString("C", CultureInfo.CurrentCulture))
                            </td>
                            <td class="text-center">
                                @using (Html.BeginForm("RemoveServiceFromCart", "Bookings", FormMethod.Post, new { @class = "remove-form" }))
                                            {
                                                @Html.AntiForgeryToken()
                                                @Html.Hidden("index", i)
                                                <button type="submit" class="btn btn-sm btn-danger">
                                                    <i class="bi bi-trash"></i>
                                                </button>
                                            }
                                        </td>
                                    </tr>
                                }
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        }

        <!-- Grand Total -->
        <div class="card shadow-sm mb-5">
            <div class="card-body d-flex justify-content-between align-items-center">
                <h5 class="mb-0 fw-bold">Grand Total:</h5>
                @*
                  Razor still calculates initial total; JS updates dynamically
                *@
                @{
                    decimal grandTotal = Model.Item1.Sum(m => m.TotalAmount)
                    + Model.Item2.Sum(c => c.TotalPrice)
                    + Model.Item3.Sum(s => s.AdditionalService?.PriceType == "Fixed" ? s.UnitPrice : s.TotalPrice);
                }
                <span class="fs-5 fw-bold text-primary grand-total">@grandTotal.ToString("C", CultureInfo.CurrentCulture)</span>
            </div>
        </div>

        <!-- Actions -->
        <div class="d-flex justify-content-between mb-5">
            @using (Html.BeginForm("CreateEvent", "Bookings", FormMethod.Get))
            {
                <button type="submit" class="btn btn-outline-primary mt-3">
                    <i class="bi bi-plus-circle"></i> Add More Bookings
                </button>
            }

            @using (Html.BeginForm("ConfirmCart", "Bookings", FormMethod.Post, new { id = "confirmCartForm" }))
            {
                @Html.AntiForgeryToken()
                <button type="submit" class="btn btn-success btn-lg">
                    <i class="bi bi-check2-circle me-2"></i> Confirm Cart
                </button>
            }
        </div>
    }
</div>

<!-- Modals -->
<div class="modal fade" id="messageModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="messageModalTitle"></h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body" id="messageModalBody"></div>
            <div class="modal-footer">
                <button type="button" class="btn btn-primary" data-bs-dismiss="modal">OK</button>
            </div>
        </div>
    </div>
</div>

<!-- Remove Confirmation Modal -->
<div class="modal fade" id="removeConfirmModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header bg-danger text-white">
                <h5 class="modal-title">Remove Item</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">Are you sure you want to remove this item from your cart?</div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-danger" id="confirmRemoveBtn">Yes, Remove</button>
            </div>
        </div>
    </div>
</div>
@section Scripts {
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script>
        $(document).ready(function () {
            // ----- Confirm Cart AJAX -----
            $("#confirmCartForm").submit(function (e) {
                e.preventDefault();
                $.ajax({
                    type: "POST",
                    url: $(this).attr("action"),
                    data: $(this).serialize(),
                    dataType: "json",
                    success: function (response) {
                        $("#messageModalBody").text(response.message);
                        if (response.success) {
                            $("#messageModalTitle")
                                .text("Success")
                                .removeClass("text-danger")
                                .addClass("text-success");
                        } else {
                            $("#messageModalTitle")
                                .text("Error")
                                .removeClass("text-success")
                                .addClass("text-danger");
                        }
                        var modal = new bootstrap.Modal(document.getElementById('messageModal'));
                        modal.show();
                        if (response.success) setTimeout(() => location.reload(), 2000);
                    },
                    error: function (xhr) {
                        let msg = "Unexpected error.";
                        if (xhr.responseJSON && xhr.responseJSON.message) msg = xhr.responseJSON.message;
                        alert(msg);
                    }
                });
            });

            // ----- Remove Items AJAX -----
            let removeForm;
            $('form.remove-form').submit(function (e) {
                e.preventDefault();
                removeForm = this;
                var modal = new bootstrap.Modal(document.getElementById('removeConfirmModal'));
                modal.show();
            });

            $('#confirmRemoveBtn').click(function () {
                if (!removeForm) return;

                $.ajax({
                    type: $(removeForm).attr('method'),
                    url: $(removeForm).attr('action'),
                    data: $(removeForm).serialize(),
                    dataType: 'json',
                    success: function (response) {
                        // hide confirmation modal
                        var confModal = bootstrap.Modal.getInstance(document.getElementById('removeConfirmModal'));
                        confModal.hide();

                        // remove row
                        $(removeForm).closest('tr').fadeOut(300, function () {
                            $(this).remove();

                            // Update grand total
                            let grandTotal = 0;
                            $('table tbody tr').each(function () {
                                let totalText = $(this).find('td:eq(3)').text();
                                grandTotal += parseFloat(totalText.replace(/[^0-9.-]+/g, "")) || 0;
                            });
                            $('.grand-total').text(new Intl.NumberFormat('en-ZA', { style: 'currency', currency: 'ZAR' }).format(grandTotal));
                        });

                        // show success modal
                        $('#messageModalTitle').text('Success').removeClass('text-danger').addClass('text-success');
                        $('#messageModalBody').text(response.message);
                        var msgModal = new bootstrap.Modal(document.getElementById('messageModal'));
                        msgModal.show();
                    },
                    error: function () {
                        alert('Error removing item.');
                    }
                });
            });

            // ----- Real-time Quantity Update -----
            $('.quantity-input').on('input', function () {
                let input = $(this);
                let qty = parseInt(input.val()) || 1;
                if (qty < 1) qty = 1;
                input.val(qty);

                let unitPrice = parseFloat(input.data('unit'));
                let totalCell = input.closest('tr').find('td:eq(3)');
                totalCell.text(new Intl.NumberFormat('en-ZA', { style: 'currency', currency: 'ZAR' }).format(unitPrice * qty));

                // Update grand total
                let grandTotal = 0;
                $('table tbody tr').each(function () {
                    let totalText = $(this).find('td:eq(3)').text();
                    grandTotal += parseFloat(totalText.replace(/[^0-9.-]+/g, "")) || 0;
                });
                $('.grand-total').text(new Intl.NumberFormat('en-ZA', { style: 'currency', currency: 'ZAR' }).format(grandTotal));
            });
        });
    </script>
}

